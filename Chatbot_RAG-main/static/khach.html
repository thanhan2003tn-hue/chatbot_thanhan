<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Chatbot Tư Vấn Tuyển Sinh - Khách</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Cố định chiều cao cửa sổ chat */
        #chatbot-container {
             height: calc(100vh - 120px);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "gray-850": "#19202e"
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "xl": "0.75rem"
                    }
                }
            }
        }
    </script>
</head>
<body class="font-display antialiased bg-background-light dark:bg-background-dark">
<div class="flex flex-col min-h-screen">
    <header class="border-b border-gray-200 dark:border-gray-700/50 bg-white dark:bg-gray-850 shadow-sm p-4 sticky top-0 z-10">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <h1 class="text-xl font-bold text-primary">TRỢ LÝ ẢO ĐHKTCN (Khách)</h1>
            <a class="flex items-center gap-2 py-2 px-4 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition-colors shadow-md" href="/">
                <span class="material-symbols-outlined">home</span>
                Trang Chủ
            </a>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center">
        <div class="w-full max-w-4xl bg-white dark:bg-gray-850 rounded-xl shadow-lg flex flex-col">
            <div id="chatbot-container" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                <div class="flex items-start gap-3">
                    <div class="size-8 text-primary shrink-0">
                        <span class="material-symbols-outlined text-3xl">smart_toy</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200 max-w-full prose">
                        <p>Chào bạn! Tôi là Trợ lý AI của Trường Đại học Kỹ thuật Công nghiệp. Tôi có thể tư vấn các vấn đề về **Tuyển sinh**, **Chương trình đào tạo**, và **Quy định sinh viên**.</p>
                        <p class="mt-2 text-xs italic text-gray-500">Bạn đang sử dụng phiên bản Khách. Vui lòng đăng nhập để sử dụng đầy đủ tính năng.</p>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 dark:border-gray-700/50 p-4 shrink-0">
                <div class="max-w-4xl mx-auto flex items-center bg-white dark:bg-gray-850 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
                    <textarea id="chat-input" class="flex-1 resize-none h-10 w-full p-3 bg-transparent border-none focus:ring-0 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" placeholder="Nhập câu hỏi của bạn..." rows="1"></textarea>
                    <button id="send-button" class="p-3 text-primary hover:text-primary/80 transition-colors shrink-0">
                        <span class="material-symbols-outlined text-lg">send</span>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const API_URL = 'http://127.0.0.1:8000/ask'; // API endpoint
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatMessagesContainer = document.getElementById('chatbot-container');

    // --- Message Creation Functions ---
    function createBotMessage(text) {
        return `
            <div class="flex items-start gap-3">
                <div class="size-8 text-primary shrink-0">
                    <span class="material-symbols-outlined text-3xl">smart_toy</span>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200 max-w-full prose">
                    ${marked.parse(text)}
                </div>
            </div>
        `;
    }

    function createUserMessage(text) {
        return `
            <div class="flex items-end justify-end">
                <div class="bg-primary text-white p-4 rounded-xl shadow-sm text-sm max-w-[85%]">
                    <p>${text}</p>
                </div>
            </div>
        `;
    }

    function createThinkingMessage() {
        // Sử dụng một ID duy nhất để dễ dàng xóa
        return `
            <div class="flex items-start gap-3" id="bot-thinking-message">
                <div class="size-8 text-primary shrink-0">
                    <span class="material-symbols-outlined text-3xl animate-spin">autorenew</span>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200">
                    <p>... Đang tìm kiếm và tạo câu trả lời...</p>
                </div>
            </div>
        `;
    }

    // --- Main Send Logic (Merged from old script.js) ---
    async function sendMessage() {
        const question = chatInput.value.trim();
        if (!question) return;

        // 1. Thêm tin nhắn người dùng và disable input
        chatMessagesContainer.innerHTML += createUserMessage(question);
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        // 2. Thêm thông báo chờ (Thinking message)
        const botThinkingMessage = createThinkingMessage();
        chatMessagesContainer.innerHTML += botThinkingMessage;
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question }),
            });

            const data = await response.json();

            // 3. Xóa tin nhắn chờ
            const thinkingElement = document.getElementById('bot-thinking-message');
            if (thinkingElement) {
                thinkingElement.remove();
            }

            // 4. Hiển thị câu trả lời hoặc lỗi
            if (response.ok && data.answer) {
                chatMessagesContainer.innerHTML += createBotMessage(data.answer);
            } else {
                chatMessagesContainer.innerHTML += createBotMessage(`**Lỗi Server:** Không nhận được câu trả lời. Chi tiết: ${data.detail || 'Lỗi không xác định'}`);
            }

        } catch (error) {
            console.error('Lỗi khi gọi API chat:', error);
            // Xóa tin nhắn chờ và báo lỗi kết nối
            const thinkingElement = document.getElementById('bot-thinking-message');
            if (thinkingElement) {
                thinkingElement.remove();
            }
            chatMessagesContainer.innerHTML += createBotMessage('**Lỗi kết nối:** Không thể kết nối đến server Chatbot. Vui lòng kiểm tra server đang chạy tại 127.0.0.1:8000.');
        } finally {
            // 5. Enable input và cuộn xuống cuối
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    }

    // Xử lý sự kiện gửi tin nhắn (Click nút)
    sendButton.addEventListener('click', sendMessage);

    // Xử lý sự kiện gửi tin nhắn (Nhấn Enter)
    chatInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>