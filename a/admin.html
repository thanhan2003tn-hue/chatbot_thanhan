<!DOCTYPE html>
<html class="light" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Trang Quản trị - Chatbot</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <script>
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                "primary": "#135bec",
                "background-light": "#f6f6f8",
                "background-dark": "#101622",
                "gray-850": "#19202e"
              },
              fontFamily: {
                "display": ["Lexend", "sans-serif"]
              },
              borderRadius: {
                "DEFAULT": "0.25rem",
                "xl": "0.75rem"
              }
            }
          }
        }
    </script>
</head>
<body class="font-display antialiased dark:bg-background-dark">

    <script>
        // Hàm logout (chung cho cả 2 trang)
        function logout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('role');
            localStorage.removeItem('fullname');
            alert('Đã đăng xuất thành công.');
            window.location.href = '/login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const role = localStorage.getItem('role');
            const fullname = localStorage.getItem('fullname');

            // 1. Kiểm tra quyền truy cập BẮT BUỘC (chỉ admin)
            if (role !== 'admin' || !fullname) {
                alert('Bạn cần đăng nhập với tài khoản Quản trị viên để truy cập trang này.');
                window.location.href = '/login.html';
                return;
            }

            // 2. Hiển thị thông tin người dùng
            document.getElementById('admin-fullname').textContent = fullname || 'Admin';

            // 3. Gán sự kiện Đăng xuất
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }

            // TODO: Triển khai các chức năng Admin (Quản lý người dùng chờ duyệt, Upload file)
            loadPendingUsers();
        });

        // Hàm Tải danh sách người dùng chờ duyệt (Ví dụ)
        async function loadPendingUsers() {
            try {
                const response = await fetch('/api/pending-users');
                const users = await response.json();

                const tableBody = document.getElementById('pending-users-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';

                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Không có tài khoản nào chờ phê duyệt.</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700';
                    row.innerHTML = `
                        <td class="px-6 py-4">${user.id}</td>
                        <td class="px-6 py-4">${user.fullname}</td>
                        <td class="px-6 py-4">${user.email}</td>
                        <td class="px-6 py-4">${user.role}</td>
                        <td class="px-6 py-4">
                            <button onclick="approveUser(${user.id})" class="text-sm font-medium text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">Phê duyệt</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Lỗi tải danh sách người dùng:', error);
                document.getElementById('pending-users-body').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>';
            }
        }

        // Hàm Phê duyệt người dùng
        async function approveUser(userId) {
            if (!confirm(`Bạn có chắc chắn muốn phê duyệt tài khoản ID ${userId} không?`)) {
                return;
            }
            try {
                const response = await fetch(`/api/approve-user/${userId}`, { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadPendingUsers(); // Tải lại danh sách sau khi phê duyệt
                } else {
                    alert(`Lỗi phê duyệt: ${result.detail || 'Lỗi không xác định'}`);
                }
            } catch (error) {
                alert('Lỗi kết nối đến server.');
            }
        }

        // Tải lại model (Retrain)
        async function retrainModel() {
            if (!confirm('Bạn có chắc chắn muốn Tái tạo lại Vector Store (Retrain Model) không? Thao tác này có thể mất vài phút.')) {
                return;
            }
            alert('Bắt đầu quá trình Retrain Model. Vui lòng chờ...');
            try {
                const response = await fetch('/retrain', { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                } else {
                    alert(`Lỗi Retrain: ${result.detail || 'Lỗi không xác định'}`);
                }
            } catch (error) {
                alert('Lỗi kết nối đến server.');
            }
        }

        // Gán sự kiện cho nút Retrain (Nếu có)
        window.addEventListener('load', () => {
            const retrainButton = document.getElementById('retrain-button');
            if (retrainButton) {
                retrainButton.addEventListener('click', retrainModel);
            }
        });

    </script>

    <div id="app" class="flex flex-col min-h-screen">
        <header class="border-b border-gray-200 dark:border-gray-700/50 bg-white dark:bg-gray-850 shadow-sm p-4 sticky top-0 z-10">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <h1 class="text-xl font-bold text-red-600">TRANG QUẢN TRỊ</h1>
                <div class="flex items-center gap-4">
                    <span class="text-gray-600 dark:text-gray-400">Xin chào, <span id="admin-fullname" class="font-medium">Admin</span></span>
                    <button id="logout-button" class="flex items-center gap-2 py-2 px-4 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors shadow-md">
                        <span class="material-symbols-outlined">logout</span>
                        Đăng xuất
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark">
            <div class="max-w-7xl mx-auto p-4 md:p-8">
                <div class="bg-white dark:bg-gray-850 rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Bảng điều khiển Quản trị</h2>

                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-primary mb-4 flex items-center gap-2"><span class="material-symbols-outlined">group</span> Quản lý Người dùng Chờ duyệt</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Họ và Tên</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Vai trò</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-users-body" class="bg-white divide-y divide-gray-200 dark:bg-gray-850 dark:divide-gray-700">
                                    <tr><td colspan="5" class="py-4 text-center text-gray-500">Đang tải...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-primary mb-4 flex items-center gap-2"><span class="material-symbols-outlined">upload_file</span> Cập nhật Dữ liệu Chatbot</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Tải lên file mới (.pdf, .docx, .txt...) sẽ tự động tái tạo cơ sở dữ liệu Vector.</p>

                        <form id="upload-form" class="flex items-center gap-4 mb-4">
                            <input type="file" id="document-file" name="file" accept=".pdf,.docx,.doc,.txt" class="block w-full text-sm text-gray-900 dark:text-gray-300 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 p-2.5">
                            <button type="submit" class="py-2.5 px-6 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors shadow-md">Tải lên</button>
                        </form>

                        <button id="retrain-button" class="py-2.5 px-6 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 transition-colors shadow-md">Tái tạo Model (Retrain)</button>
                        <p id="upload-status" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></p>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('document-file');
            const statusDiv = document.getElementById('upload-status');
            const file = fileInput.files[0];

            if (!file) {
                statusDiv.textContent = 'Vui lòng chọn một file để tải lên.';
                statusDiv.className = 'mt-2 text-sm text-red-500';
                return;
            }

            statusDiv.textContent = 'Đang tải lên và cập nhật hệ thống... Vui lòng chờ.';
            statusDiv.className = 'mt-2 text-sm text-blue-500';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/uploadfile/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.textContent = result.message;
                    statusDiv.className = 'mt-2 text-sm text-green-500';
                } else {
                    statusDiv.textContent = `Lỗi tải lên: ${result.detail || 'Lỗi không xác định'}`;
                    statusDiv.className = 'mt-2 text-sm text-red-500';
                }

            } catch (error) {
                statusDiv.textContent = 'Lỗi kết nối đến server trong quá trình tải lên.';
                statusDiv.className = 'mt-2 text-sm text-red-500';
            }
        });
    </script>
</body>
</html>