<!DOCTYPE html>
<html class="light" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Chatbot Tư Vấn Tuyển Sinh - Người dùng</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#135bec",
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
            "gray-850": "#19202e"
          },
          fontFamily: {
            "display": ["Lexend", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "xl": "0.75rem"
          }
        }
      }
    }
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    html, body, #app {
        height: 100%;
        background-color: #f6f6f8;
    }
    .dark html, .dark body, .dark #app {
        background-color: #101622;
    }
    .chat-container {
        height: 100vh;
        max-height: 100vh;
    }
    /* Đảm bảo khung chat có đủ không gian */
    .chat-messages-container {
        min-height: calc(100vh - 120px);
        max-height: calc(100vh - 120px);
    }
</style>
</head>
<body class="font-display antialiased dark:bg-background-dark">
<div class="chat-container flex flex-col">
<header class="border-b border-gray-200 dark:border-gray-700/50 bg-white dark:bg-gray-850 shadow-sm p-4 shrink-0">
<div class="flex items-center justify-between max-w-7xl mx-auto">
<h1 class="text-xl font-bold text-gray-900 dark:text-white">Chatbot TLU</h1>
<div class="flex items-center gap-4">
<button class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"><span class="material-symbols-outlined">light_mode</span></button>
<div class="relative">
<button id="user-menu-button" class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700/70">
<img alt="User Avatar" class="size-8 rounded-full object-cover" src="https://i.pravatar.cc/150?img=11"/>
<span class="text-sm font-medium text-gray-900 dark:text-white hidden sm:inline" id="user-fullname-display"></span>
<span class="material-symbols-outlined text-base">expand_more</span>
</button>
<div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-850 rounded-lg shadow-xl py-1 z-10 hidden">
<a class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" href="#">Hồ sơ</a>
<a class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" href="#logout" id="logout-button">Đăng xuất</a>
</div>
</div>
</div>
</div>
</header>
<main class="flex flex-1 overflow-hidden bg-background-light dark:bg-background-dark">
<aside class="w-64 border-r border-gray-200 dark:border-gray-700/50 bg-white dark:bg-gray-900 flex flex-col shrink-0">
<div class="p-4 border-b border-gray-200 dark:border-gray-700/50">
<button class="w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition-colors shadow-md">
<span class="material-symbols-outlined">add_comment</span>
Cuộc trò chuyện mới
</button>
</div>
<div class="flex-1 overflow-y-auto p-4 space-y-2">
<a class="flex flex-col p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" href="#">
<span class="text-sm font-medium text-gray-900 dark:text-white line-clamp-1">Học phí ngành CNTT</span>
<span class="text-xs text-gray-500 dark:text-gray-400">10:30 AM</span>
</a>
<a class="flex flex-col p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" href="#">
<span class="text-sm font-medium text-gray-900 dark:text-white line-clamp-1">Thủ tục nhập học cần những gì?</span>
<span class="text-xs text-gray-500 dark:text-gray-400">Hôm qua</span>
</a>
<a class="flex flex-col p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" href="#">
<span class="text-sm font-medium text-gray-900 dark:text-white line-clamp-1">Điểm chuẩn ngành Kỹ thuật Xây dựng</span>
<span class="text-xs text-gray-500 dark:text-gray-400">01/08/2024</span>
</a>
</div>
</aside>
<section class="flex flex-1 flex-col overflow-hidden">
<div id="chat-messages" class="chat-messages-container flex-1 overflow-y-auto px-6 py-4 space-y-4">
<div class="flex items-start gap-3">
<div class="size-8 text-primary shrink-0">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M6 6H42L36 24L42 42H6L12 24L6 6Z" fill="currentColor"></path>
</svg>
</div>
<div id="welcome-message" class="bg-white dark:bg-gray-850 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200 max-w-full">
<p>Chào bạn, tôi là Chatbot Tư vấn Tuyển sinh của Trường ĐHKTCN. Tôi có thể giúp bạn tìm kiếm thông tin về các ngành học, học phí, và thủ tục nhập học. Bạn có câu hỏi nào không?</p>
</div>
</div>
<div class="flex items-end justify-end gap-3">
<div class="bg-primary text-white p-4 rounded-xl shadow-sm text-sm max-w-full">
<p>Học phí ngành Công nghệ Thông tin là bao nhiêu?</p>
</div>
</div>
<div class="flex items-start gap-3">
<div class="size-8 text-primary shrink-0">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M6 6H42L36 24L42 42H6L12 24L6 6Z" fill="currentColor"></path>
</svg>
</div>
<div class="bg-white dark:bg-gray-850 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200 max-w-full">
<p>Học phí dự kiến cho ngành Công nghệ Thông tin (chương trình chuẩn) trong năm học 2024-2025 là khoảng **350.000 VNĐ/tín chỉ**.</p>
<p class="mt-2">Mức học phí này có thể thay đổi theo quy định của Bộ Giáo dục và Đào tạo và Hội đồng Trường. Tổng học phí sẽ phụ thuộc vào số tín chỉ bạn đăng ký học trong một kỳ.</p>
</div>
</div>
</div>
<div class="border-t border-gray-200 dark:border-gray-700/50 p-4 shrink-0">
<div class="max-w-3xl mx-auto flex items-center bg-white dark:bg-gray-850 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
<textarea id="chat-input" class="flex-1 resize-none h-10 w-full p-3 bg-transparent border-none focus:ring-0 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" placeholder="Nhập câu hỏi của bạn tại đây..." rows="1"></textarea>
<button id="send-button" class="p-3 text-primary hover:text-primary/80 transition-colors shrink-0">
<span class="material-symbols-outlined text-lg">send</span>
</button>
</div>
<p class="text-xs text-center text-gray-500 dark:text-gray-400 mt-2">Trợ lý Ảo có thể mắc lỗi. Vui lòng kiểm tra lại thông tin quan trọng.</p>
</div>
</section>
</main>
</div>

<script>
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatMessagesContainer = document.getElementById('chat-messages');
    // Đảm bảo địa chỉ này chính xác với nơi server FastAPI của bạn đang chạy
    const CHAT_API_URL = 'http://127.0.0.1:8000/ask';

    // Hàm tạo HTML cho tin nhắn của người dùng
    function createUserMessage(message) {
        return `
            <div class="flex items-end justify-end gap-3">
                <div class="bg-primary text-white p-4 rounded-xl shadow-sm text-sm max-w-[80%] md:max-w-[70%]">
                    <p>${message}</p>
                </div>
            </div>
        `;
    }

    // Hàm tạo HTML cho tin nhắn của Chatbot
    function createBotMessage(message) {
        return `
            <div class="flex items-start gap-3">
                <div class="size-8 text-primary shrink-0">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 6H42L36 24L42 42H6L12 24L6 6Z" fill="currentColor"></path>
                    </svg>
                </div>
                <div class="bg-white dark:bg-gray-850 p-4 rounded-xl shadow-sm text-sm text-gray-700 dark:text-gray-200 max-w-[80%] md:max-w-[70%]">
                    <p>${message}</p>
                </div>
            </div>
        `;
    }

    // Hàm xử lý việc gửi câu hỏi
    async function sendMessage() {
        const question = chatInput.value.trim();
        if (!question) return;

        // 1. Hiển thị tin nhắn người dùng
        chatMessagesContainer.innerHTML += createUserMessage(question);
        chatInput.value = '';
        chatInput.disabled = true;

        // Tạo khung tin nhắn chờ của bot
        const botThinkingMessage = document.createElement('div');
        botThinkingMessage.innerHTML = createBotMessage('Đang xử lý và tìm kiếm câu trả lời...');
        chatMessagesContainer.appendChild(botThinkingMessage);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        try {
            // 2. Gửi yêu cầu đến API
            const response = await fetch(CHAT_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question }),
            });

            const data = await response.json();

            // 3. Xử lý và hiển thị câu trả lời của Bot

            // Xóa tin nhắn chờ
            botThinkingMessage.remove();

            if (response.ok && data.answer) {
                // Hiển thị câu trả lời chính thức
                chatMessagesContainer.innerHTML += createBotMessage(data.answer);
            } else {
                // Xử lý lỗi từ server
                chatMessagesContainer.innerHTML += createBotMessage(`**Lỗi Server:** Không nhận được câu trả lời. Chi tiết: ${data.detail || 'Lỗi không xác định'}`);
            }

        } catch (error) {
            console.error('Lỗi khi gọi API chat:', error);
            // Xóa tin nhắn chờ và báo lỗi kết nối
            if (botThinkingMessage.parentNode) {
                botThinkingMessage.remove();
            }
            chatMessagesContainer.innerHTML += createBotMessage('**Lỗi kết nối:** Không thể kết nối đến server Chatbot. Vui lòng kiểm tra server đang chạy tại 127.0.0.1:8000.');
        }

        chatInput.disabled = false;
        chatInput.focus();
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }

    // --- BỔ SUNG LOGIC HIỂN THỊ TÊN VÀ KIỂM TRA QUYỀN (ĐÃ SỬA LỖI KEY LOCALSTORAGE) ---

    // Hàm hiển thị tên người dùng và kiểm tra vai trò
    function loadUserContext() {
        // Đã sửa: Đọc đúng khóa 'fullname' và 'role'
        const fullname = localStorage.getItem('fullname');
        const role = localStorage.getItem('role');

        // KIỂM TRA ĐĂNG NHẬP VÀ VAI TRÒ
        if (!fullname || role === 'admin' || !role) {
             // Chuyển hướng nếu chưa đăng nhập hoặc là admin
             alert('Vui lòng đăng nhập bằng tài khoản người dùng.');
             window.location.href = '/login.html';
             return;
        }

        const displayElement = document.getElementById('user-fullname-display');
        if (displayElement) {
            displayElement.textContent = fullname;
        }

        // Tùy chỉnh tin nhắn chào mừng (tùy chọn)
        const welcomeMessageP = document.querySelector('#welcome-message p');
        if (welcomeMessageP) {
             welcomeMessageP.innerHTML = `Chào bạn **${fullname}**, tôi là Chatbot Tư vấn Tuyển sinh của Trường ĐHKTCN. Tôi có thể giúp bạn tìm kiếm thông tin về các ngành học, học phí, và thủ tục nhập học. Bạn có câu hỏi nào không?`;
        }
    }

    // Hàm logout
    function logout() {
        // Đã sửa: Xóa đúng khóa
        localStorage.removeItem('user_id');
        localStorage.removeItem('role');
        localStorage.removeItem('fullname');
        window.location.href = '/login.html';
    }

    // Xử lý đóng mở menu người dùng
    document.getElementById('user-menu-button').addEventListener('click', () => {
        document.getElementById('user-menu').classList.toggle('hidden');
    });

    // Gán hàm logout vào nút "Đăng xuất"
    document.getElementById('logout-button').addEventListener('click', (event) => {
        event.preventDefault();
        logout();
    });

    // Xử lý sự kiện gửi tin nhắn (Click nút)
    sendButton.addEventListener('click', sendMessage);

    // Xử lý sự kiện gửi tin nhắn (Nhấn Enter)
    chatInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    // Cuộn xuống cuối tin nhắn khi load trang
    window.onload = () => {
        loadUserContext(); // Tải thông tin người dùng
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    };
</script>

</body>
</html>